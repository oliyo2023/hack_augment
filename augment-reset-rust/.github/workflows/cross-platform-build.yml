name: è·¨å¹³å°æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  PROJECT_NAME: augment-reset

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£… Rust å·¥å…·é“¾
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: ç¼“å­˜ Cargo ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: cargo fmt --all -- --check

    - name: Clippy æ£€æŸ¥
      run: cargo clippy --all-targets --all-features -- -D warnings

    - name: è¿è¡Œæµ‹è¯•
      run: cargo test --verbose

  # è·¨å¹³å°æ„å»º
  cross-platform-build:
    name: æ„å»º ${{ matrix.target }}
    needs: quality-check
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows ç›®æ ‡
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            name: windows-x64-msvc
            
          - target: x86_64-pc-windows-gnu
            os: windows-latest
            name: windows-x64-gnu
            
          - target: i686-pc-windows-msvc
            os: windows-latest
            name: windows-x86-msvc

          # Linux ç›®æ ‡
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: linux-x64-glibc
            
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            name: linux-x64-musl
            
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            name: linux-arm64

          # macOS ç›®æ ‡
          - target: x86_64-apple-darwin
            os: macos-latest
            name: macos-x64
            
          - target: aarch64-apple-darwin
            os: macos-latest
            name: macos-arm64

    runs-on: ${{ matrix.os }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£… Rust å·¥å…·é“¾
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: ç¼“å­˜ Cargo ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    # Linux ç‰¹æ®Šä¾èµ–
    - name: å®‰è£… Linux äº¤å‰ç¼–è¯‘ä¾èµ–
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-multilib
        
        # ARM64 äº¤å‰ç¼–è¯‘å·¥å…·
        if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
          sudo apt-get install -y gcc-aarch64-linux-gnu
        fi
        
        # musl å·¥å…·
        if [[ "${{ matrix.target }}" == *"musl"* ]]; then
          sudo apt-get install -y musl-tools
        fi

    # Windows ç‰¹æ®Šè®¾ç½®
    - name: é…ç½® Windows æ„å»ºç¯å¢ƒ
      if: matrix.os == 'windows-latest' && matrix.target == 'x86_64-pc-windows-gnu'
      run: |
        # ç¡®ä¿ MinGW åœ¨ PATH ä¸­
        echo "C:\msys64\mingw64\bin" >> $GITHUB_PATH

    - name: æ„å»ºé¡¹ç›®
      run: |
        cargo build --release --target ${{ matrix.target }} --features full
        
    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      shell: bash
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release
        
        # ç¡®å®šå¯æ‰§è¡Œæ–‡ä»¶å
        if [[ "${{ matrix.target }}" == *"windows"* ]]; then
          exe_name="${PROJECT_NAME}.exe"
        else
          exe_name="${PROJECT_NAME}"
        fi
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp "target/${{ matrix.target }}/release/${exe_name}" "release/"
        
        # å¤åˆ¶å…¶ä»–æ–‡ä»¶
        cp README.md release/ || true
        cp LICENSE release/ || true
        cp CHANGELOG.md release/ || true
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd release
        if [[ "${{ matrix.target }}" == *"windows"* ]]; then
          7z a "../${{ env.PROJECT_NAME }}-${{ matrix.name }}.zip" *
        else
          tar -czf "../${{ env.PROJECT_NAME }}-${{ matrix.name }}.tar.gz" *
        fi

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.PROJECT_NAME }}-${{ matrix.name }}
        path: |
          ${{ env.PROJECT_NAME }}-${{ matrix.name }}.*
        retention-days: 30

  # åˆ›å»ºå‘å¸ƒ
  create-release:
    name: åˆ›å»ºå‘å¸ƒ
    needs: cross-platform-build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        path: artifacts

    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release-files
        find artifacts -name "*.zip" -o -name "*.tar.gz" | while read file; do
          cp "$file" release-files/
        done
        
        # ç”Ÿæˆæ ¡éªŒå’Œ
        cd release-files
        sha256sum * > checksums.sha256

    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release-files/*
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
        body: |
          ## ğŸš€ Augment Reset v${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½
          
          é€‰æ‹©é€‚åˆæ‚¨æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬ï¼š
          
          **Windows:**
          - `augment-reset-windows-x64-msvc.zip` - Windows x64 (æ¨è)
          - `augment-reset-windows-x64-gnu.zip` - Windows x64 (GNU)
          - `augment-reset-windows-x86-msvc.zip` - Windows x86
          
          **Linux:**
          - `augment-reset-linux-x64-glibc.tar.gz` - Linux x64 (glibc)
          - `augment-reset-linux-x64-musl.tar.gz` - Linux x64 (musl, é™æ€é“¾æ¥)
          - `augment-reset-linux-arm64.tar.gz` - Linux ARM64
          
          **macOS:**
          - `augment-reset-macos-x64.tar.gz` - macOS Intel
          - `augment-reset-macos-arm64.tar.gz` - macOS Apple Silicon
          
          ### âœ… æ ¡éªŒå’Œ
          
          ä¸‹è½½åè¯·ä½¿ç”¨ `checksums.sha256` æ–‡ä»¶éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ã€‚
          
          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
          
          1. ä¸‹è½½é€‚åˆæ‚¨ç³»ç»Ÿçš„ç‰ˆæœ¬
          2. è§£å‹æ–‡ä»¶
          3. è¿è¡Œ `augment-reset` (Linux/macOS) æˆ– `augment-reset.exe` (Windows)
          
          æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
  benchmark:
    name: æ€§èƒ½åŸºå‡†æµ‹è¯•
    needs: quality-check
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£… Rust å·¥å…·é“¾
      uses: dtolnay/rust-toolchain@stable

    - name: ç¼“å­˜ Cargo ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-benchmark-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: è¿è¡ŒåŸºå‡†æµ‹è¯•
      run: |
        # å¦‚æœæœ‰åŸºå‡†æµ‹è¯•çš„è¯
        # cargo bench
        echo "åŸºå‡†æµ‹è¯•åŠŸèƒ½å¾…å®ç°"
