# Augment Reset è·¨å¹³å°ç¼–è¯‘ Makefile
# æ”¯æŒå¤šç§ç›®æ ‡å¹³å°å’Œæ„å»ºé€‰é¡¹

# é¡¹ç›®é…ç½®
PROJECT_NAME := augment-reset
VERSION := $(shell grep '^version' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
BUILD_DATE := $(shell date '+%Y-%m-%d %H:%M:%S')

# é¢œè‰²å®šä¹‰
CYAN := \033[36m
GREEN := \033[32m
YELLOW := \033[33m
RED := \033[31m
BLUE := \033[34m
NC := \033[0m

# æ„å»ºç›®æ ‡
WINDOWS_TARGETS := x86_64-pc-windows-gnu x86_64-pc-windows-msvc i686-pc-windows-gnu
LINUX_TARGETS := x86_64-unknown-linux-gnu x86_64-unknown-linux-musl aarch64-unknown-linux-gnu
MACOS_TARGETS := x86_64-apple-darwin aarch64-apple-darwin
ALL_TARGETS := $(WINDOWS_TARGETS) $(LINUX_TARGETS) $(MACOS_TARGETS)

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# æ£€æŸ¥å·¥å…·æ˜¯å¦å­˜åœ¨
HAS_CROSS := $(shell command -v cross 2> /dev/null)
HAS_CARGO := $(shell command -v cargo 2> /dev/null)
HAS_RUSTC := $(shell command -v rustc 2> /dev/null)

# é€‰æ‹©æ„å»ºå·¥å…·
ifdef HAS_CROSS
    BUILD_CMD := cross
else
    BUILD_CMD := cargo
endif

.PHONY: help info check test clean build-local build-all build-windows build-linux build-macos package install-deps install-targets

## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "$(CYAN)ğŸš€ Augment Reset è·¨å¹³å°ç¼–è¯‘å·¥å…·$(NC)"
	@echo "$(BLUE)ç‰ˆæœ¬: $(VERSION) | æ„å»ºæ—¶é—´: $(BUILD_DATE)$(NC)"
	@echo ""
	@echo "$(YELLOW)å¯ç”¨å‘½ä»¤:$(NC)"
	@echo "  $(GREEN)help$(NC)           æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo "  $(GREEN)info$(NC)           æ˜¾ç¤ºæ„å»ºç¯å¢ƒä¿¡æ¯"
	@echo "  $(GREEN)check$(NC)          ä»£ç æ£€æŸ¥å’Œæ ¼å¼åŒ–"
	@echo "  $(GREEN)test$(NC)           è¿è¡Œæµ‹è¯•"
	@echo "  $(GREEN)clean$(NC)          æ¸…ç†æ„å»ºäº§ç‰©"
	@echo ""
	@echo "$(YELLOW)æ„å»ºå‘½ä»¤:$(NC)"
	@echo "  $(GREEN)build-local$(NC)    æ„å»ºæœ¬åœ°ç‰ˆæœ¬"
	@echo "  $(GREEN)build-all$(NC)      æ„å»ºæ‰€æœ‰å¹³å°ç‰ˆæœ¬"
	@echo "  $(GREEN)build-windows$(NC)  æ„å»º Windows ç‰ˆæœ¬"
	@echo "  $(GREEN)build-linux$(NC)    æ„å»º Linux ç‰ˆæœ¬"
	@echo "  $(GREEN)build-macos$(NC)    æ„å»º macOS ç‰ˆæœ¬"
	@echo ""
	@echo "$(YELLOW)å‘å¸ƒå‘½ä»¤:$(NC)"
	@echo "  $(GREEN)package$(NC)        åˆ›å»ºå‘å¸ƒåŒ…"
	@echo "  $(GREEN)release$(NC)        å®Œæ•´å‘å¸ƒæµç¨‹"
	@echo ""
	@echo "$(YELLOW)å·¥å…·å‘½ä»¤:$(NC)"
	@echo "  $(GREEN)install-deps$(NC)   å®‰è£…æ„å»ºä¾èµ–"
	@echo "  $(GREEN)install-targets$(NC) å®‰è£…æ‰€æœ‰ç›®æ ‡å¹³å°"
	@echo ""
	@echo "$(YELLOW)ç¤ºä¾‹:$(NC)"
	@echo "  make build-local     # æ„å»ºæœ¬åœ°ç‰ˆæœ¬"
	@echo "  make build-all       # æ„å»ºæ‰€æœ‰å¹³å°ç‰ˆæœ¬"
	@echo "  make release         # å®Œæ•´å‘å¸ƒæµç¨‹"

## æ˜¾ç¤ºæ„å»ºç¯å¢ƒä¿¡æ¯
info:
	@echo "$(CYAN)ğŸ“Š æ„å»ºç¯å¢ƒä¿¡æ¯$(NC)"
	@echo "é¡¹ç›®åç§°: $(PROJECT_NAME)"
	@echo "ç‰ˆæœ¬: $(VERSION)"
	@echo "æ„å»ºæ—¶é—´: $(BUILD_DATE)"
	@echo ""
	@echo "$(YELLOW)å·¥å…·é“¾ä¿¡æ¯:$(NC)"
ifdef HAS_RUSTC
	@echo "Rust ç‰ˆæœ¬: $(shell rustc --version)"
endif
ifdef HAS_CARGO
	@echo "Cargo ç‰ˆæœ¬: $(shell cargo --version)"
endif
ifdef HAS_CROSS
	@echo "Cross ç‰ˆæœ¬: $(shell cross --version)"
	@echo "æ„å»ºå·¥å…·: cross (æ¨è)"
else
	@echo "æ„å»ºå·¥å…·: cargo (åŸºç¡€)"
	@echo "$(YELLOW)å»ºè®®å®‰è£… cross ä»¥è·å¾—æ›´å¥½çš„è·¨å¹³å°æ”¯æŒ: cargo install cross$(NC)"
endif
	@echo ""
	@echo "$(YELLOW)ç›®æ ‡å¹³å°:$(NC)"
	@echo "å½“å‰å¹³å°: $(shell rustc -vV | grep host | cut -d' ' -f2)"
	@echo "å·²å®‰è£…ç›®æ ‡: $(shell rustup target list --installed | tr '\n' ' ')"

## æ£€æŸ¥ä¾èµ–
check-deps:
ifndef HAS_CARGO
	@echo "$(RED)âŒ Cargo æœªå®‰è£…$(NC)"
	@exit 1
endif
ifndef HAS_RUSTC
	@echo "$(RED)âŒ Rust ç¼–è¯‘å™¨æœªå®‰è£…$(NC)"
	@exit 1
endif
	@echo "$(GREEN)âœ… ä¾èµ–æ£€æŸ¥é€šè¿‡$(NC)"

## ä»£ç æ£€æŸ¥å’Œæ ¼å¼åŒ–
check: check-deps
	@echo "$(BLUE)ğŸ” è¿è¡Œä»£ç æ£€æŸ¥...$(NC)"
	@cargo fmt --check || (echo "$(YELLOW)âš ï¸ ä»£ç æ ¼å¼ä¸ç¬¦åˆæ ‡å‡†ï¼Œæ­£åœ¨è‡ªåŠ¨æ ¼å¼åŒ–...$(NC)" && cargo fmt)
	@cargo clippy --all-targets --all-features -- -D warnings
	@echo "$(GREEN)âœ… ä»£ç æ£€æŸ¥é€šè¿‡$(NC)"

## è¿è¡Œæµ‹è¯•
test: check-deps
	@echo "$(BLUE)ğŸ§ª è¿è¡Œæµ‹è¯•...$(NC)"
	@cargo test --verbose
	@echo "$(GREEN)âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡$(NC)"

## æ¸…ç†æ„å»ºäº§ç‰©
clean:
	@echo "$(BLUE)ğŸ§¹ æ¸…ç†æ„å»ºäº§ç‰©...$(NC)"
	@cargo clean
	@rm -rf dist/
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(NC)"

## å®‰è£…æ„å»ºä¾èµ–
install-deps:
	@echo "$(BLUE)ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–...$(NC)"
ifndef HAS_CROSS
	@echo "å®‰è£… cross..."
	@cargo install cross
endif
	@echo "$(GREEN)âœ… ä¾èµ–å®‰è£…å®Œæˆ$(NC)"

## å®‰è£…æ‰€æœ‰ç›®æ ‡å¹³å°
install-targets: check-deps
	@echo "$(BLUE)ğŸ¯ å®‰è£…ç›®æ ‡å¹³å°...$(NC)"
	@for target in $(ALL_TARGETS); do \
		echo "å®‰è£…ç›®æ ‡: $$target"; \
		rustup target add $$target; \
	done
	@echo "$(GREEN)âœ… ç›®æ ‡å¹³å°å®‰è£…å®Œæˆ$(NC)"

## æ„å»ºå•ä¸ªç›®æ ‡çš„é€šç”¨å‡½æ•°
define build_target
	@echo "$(BLUE)ğŸ”¨ æ„å»ºç›®æ ‡: $(1)$(NC)"
	@rustup target add $(1) 2>/dev/null || true
	@mkdir -p dist/$(1)
	@$(BUILD_CMD) build --release --target $(1) --features full
	@if [ "$(1)" = *"windows"* ]; then \
		cp target/$(1)/release/$(PROJECT_NAME).exe dist/$(1)/; \
	else \
		cp target/$(1)/release/$(PROJECT_NAME) dist/$(1)/; \
	fi
	@echo "$(GREEN)âœ… æ„å»ºå®Œæˆ: $(1)$(NC)"
endef

## æ„å»ºæœ¬åœ°ç‰ˆæœ¬
build-local: check test
	@echo "$(BLUE)ğŸ  æ„å»ºæœ¬åœ°ç‰ˆæœ¬...$(NC)"
	@cargo build --release --features full
	@mkdir -p dist/local
	@if [ -f target/release/$(PROJECT_NAME).exe ]; then \
		cp target/release/$(PROJECT_NAME).exe dist/local/; \
	else \
		cp target/release/$(PROJECT_NAME) dist/local/; \
	fi
	@echo "$(GREEN)âœ… æœ¬åœ°æ„å»ºå®Œæˆ$(NC)"

## æ„å»º Windows ç‰ˆæœ¬
build-windows: check test
	@echo "$(BLUE)ğŸªŸ æ„å»º Windows ç‰ˆæœ¬...$(NC)"
	@for target in $(WINDOWS_TARGETS); do \
		$(call build_target,$$target); \
	done
	@echo "$(GREEN)âœ… Windows æ„å»ºå®Œæˆ$(NC)"

## æ„å»º Linux ç‰ˆæœ¬
build-linux: check test
	@echo "$(BLUE)ğŸ§ æ„å»º Linux ç‰ˆæœ¬...$(NC)"
	@for target in $(LINUX_TARGETS); do \
		$(call build_target,$$target); \
	done
	@echo "$(GREEN)âœ… Linux æ„å»ºå®Œæˆ$(NC)"

## æ„å»º macOS ç‰ˆæœ¬
build-macos: check test
	@echo "$(BLUE)ğŸ æ„å»º macOS ç‰ˆæœ¬...$(NC)"
	@for target in $(MACOS_TARGETS); do \
		$(call build_target,$$target); \
	done
	@echo "$(GREEN)âœ… macOS æ„å»ºå®Œæˆ$(NC)"

## æ„å»ºæ‰€æœ‰å¹³å°ç‰ˆæœ¬
build-all: check test
	@echo "$(BLUE)ğŸŒ æ„å»ºæ‰€æœ‰å¹³å°ç‰ˆæœ¬...$(NC)"
	@for target in $(ALL_TARGETS); do \
		$(call build_target,$$target); \
	done
	@echo "$(GREEN)âœ… æ‰€æœ‰å¹³å°æ„å»ºå®Œæˆ$(NC)"

## åˆ›å»ºå‘å¸ƒåŒ…
package:
	@echo "$(BLUE)ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…...$(NC)"
	@cd dist && \
	for dir in */; do \
		if [ "$$dir" != "local/" ]; then \
			target_name=$${dir%/}; \
			echo "æ‰“åŒ… $$target_name..."; \
			if echo "$$target_name" | grep -q "windows"; then \
				zip -r "$(PROJECT_NAME)-$$target_name-v$(VERSION).zip" "$$target_name/"; \
			else \
				tar -czf "$(PROJECT_NAME)-$$target_name-v$(VERSION).tar.gz" "$$target_name/"; \
			fi; \
		fi; \
	done
	@cd dist && \
	if command -v sha256sum >/dev/null 2>&1; then \
		sha256sum *.zip *.tar.gz > checksums.sha256 2>/dev/null || true; \
	elif command -v shasum >/dev/null 2>&1; then \
		shasum -a 256 *.zip *.tar.gz > checksums.sha256 2>/dev/null || true; \
	fi
	@echo "$(GREEN)âœ… å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ$(NC)"

## å®Œæ•´å‘å¸ƒæµç¨‹
release: clean build-all package
	@echo "$(GREEN)ğŸ‰ å‘å¸ƒæ„å»ºå®Œæˆï¼$(NC)"
	@echo ""
	@echo "$(BLUE)ğŸ“ å‘å¸ƒæ–‡ä»¶ä½äº dist/ ç›®å½•ä¸­:$(NC)"
	@ls -la dist/*.zip dist/*.tar.gz dist/checksums.sha256 2>/dev/null || true

## å¿«é€Ÿæ„å»ºï¼ˆè·³è¿‡æµ‹è¯•ï¼‰
quick-build:
	@echo "$(YELLOW)âš¡ å¿«é€Ÿæ„å»ºï¼ˆè·³è¿‡æµ‹è¯•ï¼‰...$(NC)"
	@cargo build --release --features full
	@echo "$(GREEN)âœ… å¿«é€Ÿæ„å»ºå®Œæˆ$(NC)"

## æœ€å°åŒ–æ„å»º
minimal-build: check-deps
	@echo "$(BLUE)ğŸ“¦ æœ€å°åŒ–æ„å»º...$(NC)"
	@cargo build --release
	@echo "$(GREEN)âœ… æœ€å°åŒ–æ„å»ºå®Œæˆ$(NC)"

## æ˜¾ç¤ºæ„å»ºç»Ÿè®¡
stats:
	@echo "$(CYAN)ğŸ“Š æ„å»ºç»Ÿè®¡$(NC)"
	@echo "ç›®æ ‡æ•°é‡: $(words $(ALL_TARGETS))"
	@echo "Windows ç›®æ ‡: $(words $(WINDOWS_TARGETS))"
	@echo "Linux ç›®æ ‡: $(words $(LINUX_TARGETS))"
	@echo "macOS ç›®æ ‡: $(words $(MACOS_TARGETS))"
	@if [ -d dist ]; then \
		echo ""; \
		echo "$(YELLOW)æ„å»ºäº§ç‰©:$(NC)"; \
		find dist -name "$(PROJECT_NAME)*" -type f | wc -l | xargs echo "å¯æ‰§è¡Œæ–‡ä»¶æ•°é‡:"; \
		find dist -name "*.zip" -o -name "*.tar.gz" | wc -l | xargs echo "å‘å¸ƒåŒ…æ•°é‡:"; \
	fi
